pipeline {
    agent any
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code...'
                checkout scm
            }
        }
        
        stage('Test') {
            steps {
                echo 'Running tests...'
                bat 'python --version'
                bat 'pip install -r requirements.txt'
                bat 'python -c "print(\'Test passed\')"'
            }
        }
        
        stage('Build') {
            steps {
                echo 'Building Docker image...'
                bat 'docker build -t naserali/hello-world-flask:%BUILD_NUMBER% .'
                bat 'docker tag naserali/hello-world-flask:%BUILD_NUMBER% naserali/hello-world-flask:latest'
            }
        }
        
        stage('Push') {
            steps {
                echo 'Pushing to Docker Hub...'
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    bat 'docker login -u %DOCKER_USER% -p %DOCKER_PASS%'
                    bat 'docker push naserali/hello-world-flask:%BUILD_NUMBER%'
                    bat 'docker push naserali/hello-world-flask:latest'
                }
            }
        }
        
        stage('Cleanup') {
            steps {
                echo 'Cleaning up...'
                bat 'docker rmi naserali/hello-world-flask:%BUILD_NUMBER% || exit 0'
                bat 'docker rmi naserali/hello-world-flask:latest || exit 0'
            }
        }
    }
    
    post {
        success {
            echo '✅ Pipeline completed successfully!'
        }
        failure {
            echo '❌ Pipeline failed!'
        }
    }
}